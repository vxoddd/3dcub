<script>
// Объект для хранения состояния корзины
let cart = {
    items: [],
    total: 0,
    count: 0
};

// Функция для сохранения корзины в localStorage
function saveCart() {
    localStorage.setItem('3dcub_cart', JSON.stringify(cart));
}

// Функция для загрузки корзины из localStorage
function loadCart() {
    const savedCart = localStorage.getItem('3dcub_cart');
    if (savedCart) {
        cart = JSON.parse(savedCart);
        updateCartUI();
    }
}

// Функция для добавления товара в корзину
function addToCart(productId, productName, price, color, quantity, image) {
    // Проверяем, есть ли уже такой товар в корзине
    const existingItemIndex = cart.items.findIndex(item => 
        item.id === productId && item.color === color
    );
    
    if (existingItemIndex > -1) {
        // Если товар уже есть, увеличиваем количество
        cart.items[existingItemIndex].quantity += quantity;
    } else {
        // Если товара нет, добавляем новый
        cart.items.push({
            id: productId,
            name: productName,
            price: price,
            color: color,
            quantity: quantity,
            image: image
        });
    }
    
    // Пересчитываем общую стоимость и количество
    calculateCartTotal();
    
    // Сохраняем корзину
    saveCart();
    
    // Обновляем интерфейс
    updateCartUI();
}

// Функция для расчета общей стоимости корзины
function calculateCartTotal() {
    cart.total = cart.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    cart.count = cart.items.reduce((sum, item) => sum + item.quantity, 0);
}

// Функция для обновления интерфейса корзины
function updateCartUI() {
    // Обновляем счетчик в хедере
    document.querySelector('.cart-count').textContent = cart.count;
    
    // Здесь можно добавить логику для отображения модального окна корзины
    // с подробной информацией о товарах
}

// Функция для отображения корзины
function showCart() {
    // Создаем модальное окно корзины
    const cartModal = document.createElement('div');
    cartModal.className = 'cart-modal';
    cartModal.innerHTML = `
        <div class="cart-modal-content">
            <div class="cart-modal-header">
                <h2>Корзина</h2>
                <span class="close-cart">&times;</span>
            </div>
            <div class="cart-items">
                ${cart.items.length > 0 ? 
                    cart.items.map(item => `
                        <div class="cart-item">
                            <img src="${item.image}" alt="${item.name}">
                            <div class="cart-item-details">
                                <h3>${item.name}</h3>
                                <p>Цвет: ${item.color}</p>
                                <p>Цена: ${item.price} руб.</p>
                                <div class="cart-item-controls">
                                    <button class="qty-btn minus" data-id="${item.id}" data-color="${item.color}">-</button>
                                    <span class="cart-item-qty">${item.quantity}</span>
                                    <button class="qty-btn plus" data-id="${item.id}" data-color="${item.color}">+</button>
                                    <button class="remove-item" data-id="${item.id}" data-color="${item.color}">Удалить</button>
                                </div>
                            </div>
                        </div>
                    `).join('') : 
                    '<p>Корзина пуста</p>'
                }
            </div>
            <div class="cart-total">
                <h3>Итого: ${cart.total} руб.</h3>
                <button class="btn btn-accent checkout-btn">Оформить заказ</button>
            </div>
        </div>
    `;
    
    // Добавляем стили для модального окна
    const style = document.createElement('style');
    style.textContent = `
        .cart-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .cart-modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .cart-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .close-cart {
            font-size: 24px;
            cursor: pointer;
        }
        .cart-item {
            display: flex;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .cart-item img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            margin-right: 15px;
        }
        .cart-item-controls {
            margin-top: 10px;
        }
        .cart-total {
            margin-top: 20px;
            text-align: right;
        }
    `;
    document.head.appendChild(style);
    
    // Добавляем модальное окно на страницу
    document.body.appendChild(cartModal);
    
    // Обработчики событий для модального окна
    cartModal.querySelector('.close-cart').addEventListener('click', () => {
        document.body.removeChild(cartModal);
    });
    
    cartModal.addEventListener('click', (e) => {
        if (e.target === cartModal) {
            document.body.removeChild(cartModal);
        }
    });
    
    // Обработчики для кнопок в корзине
    cartModal.querySelectorAll('.qty-btn.minus').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.dataset.id;
            const color = this.dataset.color;
            updateCartItemQuantity(id, color, -1);
            document.body.removeChild(cartModal);
            showCart(); // Переоткрываем корзину с обновленными данными
        });
    });
    
    cartModal.querySelectorAll('.qty-btn.plus').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.dataset.id;
            const color = this.dataset.color;
            updateCartItemQuantity(id, color, 1);
            document.body.removeChild(cartModal);
            showCart();
        });
    });
    
    cartModal.querySelectorAll('.remove-item').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.dataset.id;
            const color = this.dataset.color;
            removeCartItem(id, color);
            document.body.removeChild(cartModal);
            showCart();
        });
    });
    
    // Обработчик для кнопки оформления заказа
    cartModal.querySelector('.checkout-btn').addEventListener('click', () => {
        if (cart.items.length > 0) {
            // Здесь можно добавить логику оформления заказа
            alert('Функционал оформления заказа будет реализован в ближайшее время!');
        }
    });
}

// Функция для обновления количества товара в корзине
function updateCartItemQuantity(productId, color, change) {
    const itemIndex = cart.items.findIndex(item => 
        item.id === productId && item.color === color
    );
    
    if (itemIndex > -1) {
        cart.items[itemIndex].quantity += change;
        
        // Если количество стало 0 или меньше, удаляем товар
        if (cart.items[itemIndex].quantity <= 0) {
            cart.items.splice(itemIndex, 1);
        }
        
        calculateCartTotal();
        saveCart();
        updateCartUI();
    }
}

// Функция для удаления товара из корзины
function removeCartItem(productId, color) {
    cart.items = cart.items.filter(item => 
        !(item.id === productId && item.color === color)
    );
    
    calculateCartTotal();
    saveCart();
    updateCartUI();
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    // Загружаем корзину из localStorage
    loadCart();
    
    // Обработчики для кнопок "В корзину"
    document.querySelectorAll('.add-to-cart').forEach((button, index) => {
        button.addEventListener('click', function() {
            const productCard = this.closest('.product-card');
            const productId = `product-${index + 1}`;
            const productName = productCard.querySelector('.product-title').textContent;
            const priceText = productCard.querySelector('.product-price').textContent;
            const price = parseInt(priceText.replace(/\D/g, ''));
            const activeColor = productCard.querySelector('.color-option.active').dataset.color;
            const quantity = parseInt(productCard.querySelector('.qty-input').value);
            const image = productCard.querySelector('.product-image').src;
            
            addToCart(productId, productName, price, activeColor, quantity, image);
            
            // Анимация добавления
            this.textContent = 'Добавлено!';
            this.style.backgroundColor = 'var(--success)';
            setTimeout(() => {
                this.textContent = 'В корзину';
                this.style.backgroundColor = 'var(--primary)';
            }, 1500);
        });
    });
    
    // Обработчик для иконки корзины
    document.querySelector('.cart-icon').addEventListener('click', showCart);
    
    // Выбор цвета
    document.querySelectorAll('.color-option').forEach(option => {
        option.addEventListener('click', function() {
            this.parentElement.querySelectorAll('.color-option').forEach(opt => {
                opt.classList.remove('active');
            });
            this.classList.add('active');
        });
    });
    
    // Управление количеством
    document.querySelectorAll('.qty-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const input = this.parentElement.querySelector('.qty-input');
            let value = parseInt(input.value);
            
            if (this.classList.contains('minus')) {
                if (value > 1) {
                    input.value = value - 1;
                }
            } else {
                input.value = value + 1;
            }
        });
    });
    
    // Обработка формы
    document.querySelector('.contact-form').addEventListener('submit', function(e) {
        e.preventDefault();
        alert('Спасибо за ваше сообщение! Мы свяжемся с вами в ближайшее время.');
        this.reset();
    });
    
    // Мобильное меню
    document.querySelector('.mobile-menu-btn').addEventListener('click', function() {
        document.querySelector('nav ul').classList.toggle('show');
    });
});
</script>
